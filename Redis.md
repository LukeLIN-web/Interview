## Redis

## 基本数据结构

### String 字符串

使用场景：如博客的文章数量，粉丝数量。

#### 底层结构

底层结构为简单动态字符串SDS（simple dynamic String

1. SDS 中 len 保存这字符串的长度，O(1) 时间复杂度查询字符串长度信息。
2. 针对缓存频繁修改的情况：SDS分配内存不仅会分配需要的空间，还会分配额外的空间。
   - 小于1MB的SDS每次分配与len属性同样大小的空间
   - 大于1MB的每次分配1MB
3. **使用惰性释放策略**：不立即使用内存重分配来回收缩短后多出来的字节，而是使用free属性，记录字节数量

编码方式：

- embstr编码：保存的是一个字符串值，且长度<=39，则字符串对象使用的是embstr编码方式保存
- raw编码： 对embstr字符串执行任何修改命令时，程序会转换编码为raw
- 中文默认占三个字符。

> 优先使用embstr编码的原因：embstr方式在内存分配时仅会调用一次内存分配函数，而raw会调用两次。embstr保存在一块连续内存。

#### 相关指令

相关指令：

- set 'key' 'value'
- get 'key'
- append 'key' 'appendValue'
- strlen 'key' 查长度







所有都是atmoic的.怎么做到的? 

过期时间

    SET resource:lock "Redis Demo"
    EXPIRE resource:lock 120
    TTL resource:lock => 113
    结束了就显示-2,key不存在
    -1表示不会过期,如果set了新值, 那么ttl会reset成-1
    可以直接设置ttl :
    SET resource:lock "Redis Demo 3" EX 5
    PERSIST resource:lock

### Set

#### 底层结构

集合对象的编码可以是intset 或者 hashtable

> intset整数集合作为底层实现，包含的所有元素都被保存在整数集合里面。

编码转换条件：同时满足以下两条件时，对象使用intset编码否则使用hashtable

- 集合对象保存的所有元素都是整数值。
- 集合对象保存的元素数量不超过512个。

### 有序集合 zset

有序集合的编码可以是ziplist或者skiplist

- ziplist按分值从小到大的进行排序，分值小的元素放在靠近表头方向，对象在前值在后，两者紧凑。
- skiplist编码的有序集合使用zset结构作为底层实现，一个zset结构同时包含一个字典和跳跃表

编码转换条件：满足以下两个条件使用ziplist，否则skiplist

- 有序集合保存的元素数量小于128个。
- 有序集合保存的所有元素成员的长度都小于64个字节。

skipList 跳跃表是一种有序数据结构，它通过在每个节点中维持多个指向其他节点的指针，从而达到快速访问节点的目的。 跳表在链表的基础上，增加了多层级索引，通过索引位置的几个跳转，实现数据的快速定位。

**区间查找数据**，红黑树的效率没有跳表高。跳表可以做到 O(logn) 的时间复杂度定位区间的起点，原始链表中顺序往后遍历，非常高效。

## 数据过期清理策略

过期键的删除策略

- 定时删除，为每个过期键建立一个timer，缺点占用CPU

- 惰性删除，键获取的时候判断过期再清除，对内存不友好。

- Redis使用惰性删除和定期删除结合的方式配合使用。

- 定期删除，即根据设定执行时长和操作频率清理，缺点难以确定。

  > Redis 底层会通过限制删除操作执行的时长和频率来减少删除操作对CPU时间的影响，默认100ms就随机抽一些设置了过期时间的key，不会扫描全部的过期键，因为开销过大。

redis在内存空间不足的时候，为了保证命中率，就会选择一定的数据淘汰策略——**内存淘汰机制（过期键的补充措施）**

内存淘汰机制：八种大体上可以分为4中，lru（最近最少使用）、lfu（最少使用频率）、random（随机）、ttl（根据生存时间，快过期）。

## 为什么用redis?

MySQL 数据库对于并发的场景天然支持不好，单机支撑到 2000QPS 也开始容易报警了。

> MySQL 这类的数据库的 QPS 大概都在 1w 左右（4 核 8g）

**redis的高性能**：比如在计算集装箱的保证金的时候，需要管理到运输合同、运输任务、车队的信息，计算需要多次查询mysql数据库动态汇总出结果。那针对相关的这种情况就可以把计算结果放缓存中，若没有出现数据变更的情况，就直接查缓存，减轻数据库压力。

> 针对系统物料、规格、港口、车队人员信息这种日常不经常更新的数据，也可以放在缓存中。

**redis高并发**：系统在下午高峰时间段，外部车队、船公司、内部的工厂及业务人员的业务操作比较集中，单单使用mysql数据库，在系统业务操作高峰时间数据库压力较大。

redis 分布式锁：保证集群之间的资源同步。

